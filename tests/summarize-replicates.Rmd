---
title: "Simulation Results"
author: "Michael Sachs"
date: "1/26/2022"
output: html_document
params: 
    path: "sim-res/res-nonlin-take2-0-0-001.rds"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(ggplot2)
library(patchwork)
library(dpsurrogate)
library(splines)
library(knitr)


summary_scenario <- function(teff) {
  par(mfrow = c(2, 2))
  plot(yeff ~ seff, data = teff)
  plot(yeff ~ trtZ, data = teff)
  
  ## partial residuals
  
  fit.z <- lm(yeff ~ bs(trtZ, df = 3), data = teff)
  fit.s <- lm(yeff ~ bs(seff, df = 3), data = teff)
  
  plot(resid(fit.z) ~ teff$seff, ylab = "p resid | Z", xlab = "seff")
  plot(resid(fit.s) ~ teff$trtZ, ylab = "p resid | seff", xlab = "trtZ")
  
  summary(lm(yeff ~ seff + trtZ, data = teff))
  
  
}
```

```{r}
  
  res1 <- readRDS(params$path)
  res1$trueeffects$group <- as.numeric(factor(res1$trueeffects$J))
  res1$leaveouts <- do.call(rbind, res1$leaveouts)

```


## Data generating mechanism


```{r}  
summary_scenario(res1$trueeffects)
```

## Sample sizes

```{r}
sort(res1$trueeffects$ngrp)

  tmp <- merge(res1$leaveouts, res1$alleffects, by.x = "leftout", by.y = "group")
  tmp1 <- merge(res1$leaveouts, res1$trueeffects, by.x ="leftout", by.y = "group")

```

## Simulation results

### Distribution of D based on full data estimated Yeff  
  
```{r}

  kable(rbind(DPM = summary(with(tmp, abs(dpsur - dpsur.yeff))), 
  Null = summary(with(tmp, abs(null - dpsur.yeff))),
  Simple = summary(with(tmp, abs(simple - dpsur.yeff)))), digits = 3)


cheez2 <-  tmp
cheez2$D <- abs(cheez2$simple.yeff - cheez2$dpsur)
cheez2$D0 <- abs(cheez2$simple.yeff - cheez2$null)
cheez2$Ds <- abs(cheez2$simple.yeff - cheez2$simple)

data.frame(err = c(cheez2$D, cheez2$D0, cheez2$Ds),
           type = rep(c("DPM", "null", "simple"), each = nrow(cheez2))) |>
  ggplot(aes(x = err, color = type)) + geom_density() + theme_bw()

```

### Distribution of D based on true Yeff

```{r}
  
  kable(rbind(DPM = summary(with(tmp1, abs(dpsur - yeff))), 
  Null = summary(with(tmp1, abs(null - yeff))), 
  Simple = summary(with(tmp1, abs(simple - yeff)))), digits = 3)
  
  
cheez2 <-  merge(res1$leaveouts, res1$trueeffects, by.x = "leftout", by.y = "group")

cheez2$D <- abs(cheez2$dpsur - cheez2$yeff)
cheez2$D0 <- abs(cheez2$null - cheez2$yeff)
cheez2$Ds <- abs(cheez2$simple - cheez2$yeff)

data.frame(err = c(cheez2$D, cheez2$D0, cheez2$Ds),
           type = rep(c("DPM", "null", "simple"), each = nrow(cheez2))) |>
  ggplot(aes(x = err, color = type)) + geom_density() + theme_bw()

```  
  
  
### Prediction performance

```{r, fig.height = 9}  
ests <- res1$leaveouts |> group_by(leftout) |> summarize(dpsur = median(dpsur),
                                                         null = median(null),
                                                         simple = median(simple))
ests <- merge(ests, res1$trueeffects, by.x = "leftout", by.y = "group")

mmax <- with(ests, c(min(c(yeff, dpsur, simple, null)), max(c(yeff, dpsur, simple, null))))

p1 <- ggplot(ests, aes(x = seff, y = yeff, xend = seff, yend = dpsur)) +
  geom_segment() +
  geom_point(shape = 1) +
  geom_point(aes(x = seff, y = dpsur)) + theme_bw() +
  xlab("estimated nu") + ylab("estimated mu") +
  guides(alpha = "none") + ggtitle("Leave one outs medians (filled) vs full (open) - DPM") +
  ylim(mmax)


p2 <- ggplot(ests, aes(x = seff, y = yeff, xend = seff, yend = null)) +
  geom_segment() +
  geom_point(shape = 1) +
  geom_point(aes(x = seff, y = null)) + theme_bw() +
  xlab("estimated nu") + ylab("estimated mu") +
  guides(alpha = "none") + ggtitle("Leave one outs median (filled) vs full (open) - NULL")+
  ylim(mmax)



p3 <- ggplot(ests, aes(x = seff, y = yeff, xend = seff, yend = simple)) +
  geom_segment() +
  geom_point(shape = 1) +
  geom_point(aes(x = seff, y = simple)) + theme_bw() +
  xlab("estimated nu") + ylab("estimated mu") +
  guides(alpha = "none") + ggtitle("Leave one outs median (filled) vs full (open) - Simple")+
  ylim(mmax)

p1 + p2 + p3 + plot_layout(ncol = 1)
```

```{r}
mmax <- with(ests, c(min(c(dpsur - yeff, simple - yeff)), max(c(dpsur - yeff, simple - yeff))))

p1 <- ggplot(ests, aes(x = ngrp, y = dpsur - yeff)) + geom_point() +
  ylim(mmax) + xlab("Group sample size") + ylab("Error") + ggtitle("DPM") + theme_bw()
p2 <- ggplot(ests, aes(x = ngrp, y = simple - yeff)) + geom_point() +
  ylim(mmax) +  xlab("Group sample size") + ylab("Error") + ggtitle("Simple") + theme_bw()

p1 + p2 + plot_layout(ncol = 2)
```

```{r, fig.height = 9}
mmax <- c(-5, 5)

p1 <- ggplot(cheez2, aes(x = seff, y = dpsur)) + geom_density2d() +
  geom_point(data = res1$trueeffects, aes(x = seff, y = yeff)) + theme_bw() +
  ggtitle("DPM") + ylim(mmax)

p2 <- ggplot(cheez2, aes(x = seff, y = null)) + geom_density2d() +
  geom_point(data = res1$trueeffects, aes(x = seff, y = yeff)) + theme_bw() +
  ggtitle("NULL") + ylim(mmax)


p3 <-ggplot(cheez2, aes(x = seff, y = simple)) + geom_density2d() +
  geom_point(data = res1$trueeffects, aes(x = seff, y = yeff)) + theme_bw() +
  ggtitle("Simple") + ylim(mmax)

p1+p2+p3 + plot_layout(ncol = 1)

```

